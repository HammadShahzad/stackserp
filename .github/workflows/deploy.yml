name: Build & Deploy to Droplet

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_HOST: 167.71.96.242
  DEPLOY_USER: root
  DEPLOY_PATH: /var/www/stackserp

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build Next.js (standalone)
        run: npm run build
        env:
          # Build-time env vars (only what Next.js needs at build time)
          # DATABASE_URL uses a dummy value at build time — all DB pages are force-dynamic
          # and only run at request time on the server where the real value is set.
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://build:build@localhost/build' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'build-time-secret' }}
          # NEXTAUTH_URL must be a valid non-empty URL — next-auth/react calls new URL() at module level.
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'https://stackserp.com' }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID || '' }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET || '' }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY || '' }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY || '' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://stackserp.com' }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY || '' }}

      # Copy static assets into standalone output (required by Next.js standalone)
      - name: Prepare standalone bundle
        run: |
          cp -r public .next/standalone/public
          cp -r .next/static .next/standalone/.next/static

      - name: Setup SSH (password auth)
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Sync DB schema (add missing columns/tables)
        run: npx prisma db push --accept-data-loss --skip-generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Sync standalone build to droplet
        env:
          DEPLOY_PASS: ${{ secrets.DROPLET_PASSWORD }}
        run: |
          R="sshpass -p \"$DEPLOY_PASS\" ssh -o StrictHostKeyChecking=no"
          rsync -avz --delete --exclude '.env' -e "$R" .next/standalone/ ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/.next/standalone/
          rsync -avz --delete -e "$R" .next/static/ ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/.next/static/
          rsync -avz --delete -e "$R" public/ ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/public/
          rsync -avz -e "$R" ecosystem.config.js worker.js package.json prisma/ ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Reload PM2 app
        env:
          DEPLOY_PASS: ${{ secrets.DROPLET_PASSWORD }}
        run: |
          sshpass -p "$DEPLOY_PASS" ssh -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "cd /var/www/stackserp && pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production && pm2 save && sleep 3 && pm2 list && curl -s --max-time 5 http://127.0.0.1:3001 -o /dev/null -w 'Health check: %{http_code}\n' || echo 'App starting up...'"

      - name: Deployment summary
        run: |
          echo "✅ Deployed to http://${{ env.DEPLOY_HOST }}:3001"
          echo "   Standalone build: no node_modules needed on droplet"
          echo "   PM2 reloaded with zero downtime"
